
# 新闻搜索

大文件下载
[http://url.cn/42cWygb](http://url.cn/42cWygb)
- 分词后的新闻  **all_seg.txt**
- pickle序列化的新闻字典    **newsDic**
- 倒排索引  **postingList**
- word2vec模型  **word2vec.model**
- doc2vec相似新闻文件   **doc_similar_dict.bin**


## 数据爬取
抓取虎扑体育、新浪体育、搜狐体育、新浪体育的新闻。
提取的字段包括：
- url
- 标题
- 正文
- 发布时间  （用于时间排序）
- 分类  （暂时没用到）
- 关键字    (暂时没用到）
- 评论数 （用于热度排序）
- 来源 (虎扑or腾讯)
- 抓取时间 (暂时没用到）
- id （来自url）

每条新闻以json格式存储：
存在一个文本文件里，每行为一个json
```
{
"keyword": "",
"origin": "", 
"hot": 0, 
"id": "sohu_475129229", 
"title": "", 
"url": "http://sports.sohu.com/20161207/n475129229.shtml", "crawl_date": "2016-12-09 00:25", 
"report_date": "2016-12-07 05:54", 
"content": "", 
"category": ""
}
```

## 数据处理
为了更方便的使用新闻数据，对抓取到的新闻的json进行了以下的处理
1. 对标题、正文内容进行分词（jieba分词搜索引擎分词模式），并记录分词个数（BM25模型需要文档长度），在原json中加入这几个字段，保存
2. 读取上一步处理的json（已分词的），读入一个大的字典：键为新闻id，值为新闻，每个新闻同样以字典形式保存。将这个字典用pickle序列化保存到文件（后续可以直接读取这个字典，用dict[docId]来取得新闻，用dict[docId]['title']等方式来获取新闻标题等）
```
{
"sohu_475129229":{"id":"xxx","title":"xxx","content":"xxx"...},
"hupu_22334455":{"id":"xxx","title":"xxx","content":"xxx"...},
...
}
```

## 倒排索引
从分词文件中读取新闻**标题**和**正文**构建倒排索引，以字典的数据结构存储:
```
"詹姆斯":{"df":(10,20),"docs":[("sohu_475129229",5,1),("hupu_22334455",10,0),...]},
...
```
每个词条对应一个字典：
- "df" 保存一个两个数的元组：为该词的df,前一个值为正文df，后一个值为标题df
- "docs" 保存出现该词的文档id和词频的列表： 每个元素为一元组，分别为文档id、正文中的tf、标题中的tf

## 停用词
以上各过程均没有处理停用词，因为最后查的效果还挺好

## 新闻检索

### 检索模型
用了BM25检索模型，《信息检索导论》P160 公式11-32
参数k1据说1.2~2之间较好
参数b据说取0.75较好

### 检索方法
1. 分词，对每个词查找索引，找到其相应的文档列表
2. 用BM25模型计算每个文档的得分，正文和标题分别给一定的权重进行计算。
3. 排序，得到结果

### 按热度排序

先查找索引，找出所有包含查询词的文档。
热度计算使用了HackerNews的热度计算公式，用到了评论数，新闻发布时间
[http://www.ruanyifeng.com/blog/2012/02/ranking_algorithm_hacker_news.html](http://www.ruanyifeng.com/blog/2012/02/ranking_algorithm_hacker_news.html)

### 按时间排序
没什么好说的

## 相关搜索/相似新闻
用了python gemsim库的word2Vec和doc2Vec
[Word2Vec](http://radimrehurek.com/gensim/models/word2vec.html)
word2Vec可以在分好词的文本上训练，可把词表示为向量。
1. 从分好词的json文件中构造训练数据
2. 训练word2vec模型
3. 保存/读取模型
4. model.most_similar(positive=['word1','word2',...]) 可返回与这些词最相似的n个词
可用以上来时间“相关搜索提示”功能

doc2Vec也类似，可通过训练模型，得到文档向量。可计算最相似的n个文档。
可以来实现“相似新闻推荐”功能
“相似新闻”线下训练好了，结果存到了一个文件里，每个新闻有5条相似新闻。

目前训练的时候，[@libowei1213](https://github.com/libowei1213)去掉了停用词（网上找的一个停用词表）

## 摘要
把新闻以句子为单元划分，在预先指定的窗口大小内，统计各个窗口内包含检索关键字的数目作为窗口的得分。
寻找最大得分的窗口作为摘要。

## 关键字高亮
高亮显示标题，摘要以及新闻内容

## 前端
flask+bootstrap

上面是搜索框。
中间是搜索结果，右面是相关搜索推荐。

新闻展示页面。
最下面有五条相似新闻推荐。

url的形式为
- 搜索： 
```python
/query/詹姆斯  #默认按相关度排序（BM25模型）
/query/詹姆斯?order=1   #按热度降序
/query/詹姆斯?order=2   #按时间降序
```
- 查看新闻
```
/news/hupu_2322424  #查看id为xxx的新闻
```



## 还需要完成的内容
1. 热度和时间排序， 感觉前面的新闻都太不相关了，怎么改改？
2. 前端：分页，排版。
3. 有点吃内存，现在有4个G好像。  新闻可以存到数据库里

## 其他的
分词时候 大小写没有处理。